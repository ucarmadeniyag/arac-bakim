<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Araç Bakım Takip - Gelişmiş</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f9f9fb;
      margin: 0;
      padding: 20px;
      color: #333;
      min-height: 100vh;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
      font-weight: 700;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 25px 30px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      border-radius: 12px;
      margin-bottom: 40px;
    }

    /* Arama formu */
    #aramaForm {
      display: flex;
      gap: 10px;
      margin-bottom: 25px;
      flex-wrap: wrap;
      justify-content: center;
    }
    #aramaForm input, #aramaForm button {
      font-size: 1rem;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      transition: border-color 0.3s ease;
      min-width: 200px;
    }
    #aramaForm input:focus {
      border-color: #2980b9;
      outline: none;
    }
    #aramaForm button {
      background-color: #2980b9;
      color: white;
      border: none;
      cursor: pointer;
      max-width: 120px;
      font-weight: 600;
      min-width: 80px;
    }
    #aramaForm button:hover {
      background-color: #1c5980;
    }

    /* Kayıt listesi tablosu */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 1rem;
      margin-top: 10px;
    }
    thead {
      background-color: #2980b9;
      color: white;
      text-align: left;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #ddd;
    }
    tr:hover {
      background-color: #f1f7fb;
    }

    .btn-sil {
      background-color: #e74c3c;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    .btn-sil:hover {
      background-color: #c0392b;
    }

    /* Mesaj ve bilgi alanı */
    #message {
      margin: 15px 0;
      text-align: center;
      font-weight: 600;
      color: #2980b9;
      min-height: 22px;
    }

    /* Yeni bakım formu */
    #ekleForm {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 30px;
      justify-content: center;
    }
    #ekleForm input, #ekleForm button {
      font-size: 1rem;
      padding: 10px 15px;
      border-radius: 8px;
      border: 1.5px solid #ccc;
      transition: border-color 0.3s ease;
      min-width: 180px;
    }
    #ekleForm input:focus {
      border-color: #2980b9;
      outline: none;
    }
    #ekleForm button {
      background-color: #27ae60;
      color: white;
      border: none;
      cursor: pointer;
      max-width: 130px;
      font-weight: 600;
      min-width: 100px;
    }
    #ekleForm button:hover {
      background-color: #1e874b;
    }

    /* Geçmiş plakalar listesi */
    #plakalarListesi {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 10px;
      max-height: 150px;
      overflow-y: auto;
      background: #fefefe;
    }
    #plakalarListesi h2 {
      margin-top: 0;
      font-size: 1.2rem;
      color: #34495e;
    }
    #plakalarListesi button {
      background-color: #2980b9;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      margin: 5px 5px 5px 0;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background-color 0.3s ease;
    }
    #plakalarListesi button:hover {
      background-color: #1c5980;
    }

    /* QR kod bölümü */
    #qrKodu {
      margin-top: 20px;
      text-align: center;
    }

  </style>
</head>
<body>
  <div class="container">
    <h1>Araç Bakım Takip</h1>

    <!-- Plaka arama alanı -->
    <form id="aramaForm" onsubmit="return false;">
      <input type="text" id="aramaPlaka" placeholder="Araç Plakası Girin (örn: 43UU111)" pattern="[A-Za-z0-9]{2,10}" title="Geçerli plaka girin" required />
      <button id="btnAra">Ara</button>
    </form>

    <!-- Yeni bakım ekleme formu -->
    <form id="ekleForm">
      <input type="text" id="eklePlaka" placeholder="Plaka" pattern="[A-Za-z0-9]{2,10}" title="Geçerli plaka girin" required />
      <input type="date" id="ekleTarih" required />
      <input type="text" id="ekleIslem" placeholder="Yapılan İşlem" minlength="2" required />
      <button type="submit">Bakım Ekle</button>
    </form>

    <div id="message"></div>

    <!-- Bakım kayıtları tablosu -->
    <table>
      <thead>
        <tr>
          <th>Plaka</th>
          <th>Tarih</th>
          <th>İşlem</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody id="bakimlarListesi">
        <!-- Kayıtlar buraya gelecek -->
      </tbody>
    </table>

    <!-- QR kodu gösterimi -->
    <div id="qrKodu"></div>
  </div>

  <!-- Geçmişte eklenmiş plakalar -->
  <div class="container" style="max-width: 800px;">
    <div id="plakalarListesi">
      <h2>Geçmişte Eklenen Plakalar</h2>
      <!-- Plakalar buton olarak gelecek -->
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
<script>
  const aramaPlakaInput = document.getElementById('aramaPlaka');
  const btnAra = document.getElementById('btnAra');
  const ekleForm = document.getElementById('ekleForm');
  const eklePlakaInput = document.getElementById('eklePlaka');
  const ekleTarihInput = document.getElementById('ekleTarih');
  const ekleIslemInput = document.getElementById('ekleIslem');
  const bakimlarListesi = document.getElementById('bakimlarListesi');
  const message = document.getElementById('message');
  const plakalarListesi = document.getElementById('plakalarListesi');
  const qrDiv = document.getElementById('qrKodu');
  let qrCode;

  // QR kod oluşturma fonksiyonu
  function olusturQrKod(plaka) {
    if (qrCode) {
      qrDiv.innerHTML = ""; // Önceki QR kodu temizle
    }
    // Burada URL'yi kendi domainin ile değiştir
    const url = `${window.location.origin}?plaka=${encodeURIComponent(plaka)}`;

    qrCode = new QRCode(qrDiv, {
      text: url,
      width: 150,
      height: 150,
    });
  }

  // Bakımları listele
  async function listele(plaka) {
    if (!plaka) {
      bakimlarListesi.innerHTML = '';
      message.textContent = '';
      qrDiv.innerHTML = ''; // QR kodu temizle
      return;
    }
    try {
      const res = await fetch(`/api/bakimlar/${plaka.toUpperCase()}`);
      if (!res.ok) throw new Error('Sunucu hatası');
      const bakimlar = await res.json();

      bakimlarListesi.innerHTML = '';

      if (bakimlar.length === 0) {
        message.textContent = "Bu plakaya ait bakım kaydı bulunamadı.";
        qrDiv.innerHTML = ''; // QR kodu temizle
        return;
      } else {
        message.textContent = '';
      }

      bakimlar.forEach((kayit, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${plaka.toUpperCase()}</td>
          <td>${kayit.tarih}</td>
          <td>${kayit.islem}</td>
          <td><button class="btn-sil">Sil</button></td>
        `;
        const btnSil = tr.querySelector('button');
        btnSil.onclick = async () => {
          if (!confirm('Bu kaydı silmek istediğinizden emin misiniz?')) return;
          try {
            const res = await fetch(`/api/bakimlar/${plaka.toUpperCase()}/${index}`, { method: 'DELETE' });
            const data = await res.json();
            if (res.ok) {
              message.textContent = data.message;
              listele(plaka);
              await listeTümPlakalar(); // Silince plakalar güncellenebilir
              olusturQrKod(plaka); // QR kodu güncelle
            } else {
              alert(data.message || 'Silme işlemi başarısız');
            }
          } catch {
            alert('Silme sırasında hata oluştu.');
          }
        };
        bakimlarListesi.appendChild(tr);
      });

      olusturQrKod(plaka); // Bakımlar listelendiğinde QR kodu oluştur

    } catch (err) {
      message.textContent = 'Bakım kayıtları alınırken hata oluştu.';
      qrDiv.innerHTML = ''; // Hata durumunda QR kodu temizle
      console.error(err);
    }
  }

  // Yeni bakım kaydı ekle
  ekleForm.onsubmit = async e => {
    e.preventDefault();
    const plaka = eklePlakaInput.value.trim().toUpperCase();
    const tarih = ekleTarihInput.value;
    const islem = ekleIslemInput.value.trim();

    if (!plaka || !tarih || !islem) {
      message.textContent = 'Lütfen tüm alanları doldurun.';
      return;
    }

    try {
      const res = await fetch(`/api/bakimlar/${plaka}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tarih, islem })
      });
      const data = await res.json();
      if (res.ok) {
        message.textContent = data.message;
        ekleTarihInput.value = '';
        ekleIslemInput.value = '';
        aramaPlakaInput.value = plaka; // Arama kutusunu da güncelle
        listele(plaka);
        await listeTümPlakalar();

        olusturQrKod(plaka);  // QR kodu oluşturma eklendi

      } else {
        message.textContent = data.message || 'Kayıt eklenirken hata oluştu.';
      }
    } catch {
      message.textContent = 'Sunucu ile bağlantı kurulamadı.';
    }
  };

  // Arama butonu tıklayınca listele
  btnAra.onclick = () => {
    const plaka = aramaPlakaInput.value.trim().toUpperCase();
    if (!plaka) {
      message.textContent = "Lütfen geçerli bir plaka giriniz.";
      return;
    }
    listele(plaka);
  };

  // Tüm plakaları listele (backend'den)
