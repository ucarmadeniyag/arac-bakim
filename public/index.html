<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Araç Bakım Takip - Gelişmiş</title>
  <style>
    /* (Burada CSS kodların aynen kalabilir, senin verdiğin hali) */
    /* ... */
  </style>
</head>
<body>

  <!-- Menü -->
  <nav id="mainMenu">
    <ul>
      <li><a href="/">Ana Sayfa</a></li>
      <li><a href="/bakimlar.html">Bakım Kayıtları</a></li>
      <li><a href="/hakkimizda.html">Hakkımızda</a></li>
      <li><a href="/iletisim.html">İletişim</a></li>
    </ul>
  </nav>

  <!-- Ana içerik -->
  <div class="container">
    <h1>Araç Bakım Takip</h1>

    <!-- Plaka arama alanı -->
    <form id="aramaForm" onsubmit="return false;">
      <input type="text" id="aramaPlaka" placeholder="Araç Plakası Girin (örn: 43UU111)" pattern="[A-Za-z0-9]{2,10}" title="Geçerli plaka girin" required />
      <button id="btnAra">Ara</button>
    </form>

    <!-- Yeni bakım ekleme formu -->
    <form id="ekleForm">
      <input type="text" id="eklePlaka" placeholder="Plaka" pattern="[A-Za-z0-9]{2,10}" title="Geçerli plaka girin" required />
      <input type="date" id="ekleTarih" required />
      <input type="text" id="ekleIslem" placeholder="Yapılan İşlem" minlength="2" required />
      <button type="submit">Bakım Ekle</button>
    </form>

    <div id="message"></div>

    <!-- Bakım kayıtları tablosu -->
    <table>
      <thead>
        <tr>
          <th>Plaka</th>
          <th>Tarih</th>
          <th>İşlem</th>
        
        </tr>
      </thead>
      <tbody id="bakimlarListesi">
        <!-- Kayıtlar buraya gelecek -->
      </tbody>
    </table>

    <!-- QR kodu gösterimi -->
    <div id="qrKodu"></div>
  </div>

  <!-- Geçmişte eklenmiş plakalar -->
  <div id="plakalarListesi">
    <h2>Geçmişte Eklenen Plakalar</h2>
    <!-- Plakalar buton olarak gelecek -->
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    const aramaPlakaInput = document.getElementById('aramaPlaka');
    const btnAra = document.getElementById('btnAra');
    const ekleForm = document.getElementById('ekleForm');
    const eklePlakaInput = document.getElementById('eklePlaka');
    const ekleTarihInput = document.getElementById('ekleTarih');
    const ekleIslemInput = document.getElementById('ekleIslem');
    const bakimlarListesi = document.getElementById('bakimlarListesi');
    const message = document.getElementById('message');
    const plakalarListesi = document.getElementById('plakalarListesi');
    const qrDiv = document.getElementById('qrKodu');
    let qrCode;

    function olusturQrKod(plaka) {
      if (qrCode) {
        qrCode.clear();
        qrDiv.innerHTML = '';
      }
      const url = `${window.location.origin}?plaka=${encodeURIComponent(plaka)}`;

      qrCode = new QRCode(qrDiv, {
        text: url,
        width: 150,
        height: 150,
      });
    }

    async function listele(plaka) {
      if (!plaka) {
        bakimlarListesi.innerHTML = '';
        message.textContent = '';
        qrDiv.innerHTML = '';
        return;
      }
      try {
        const res = await fetch(`/api/bakimlar/${plaka.toUpperCase()}`);
        if (!res.ok) throw new Error('Sunucu hatası');
        const bakimlar = await res.json();

        bakimlarListesi.innerHTML = '';
        if (bakimlar.length === 0) {
          message.textContent = "Bu plakaya ait bakım kaydı bulunamadı.";
          qrDiv.innerHTML = '';
          return;
        } else {
          message.textContent = '';
        }

        bakimlar.forEach((kayit, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${plaka.toUpperCase()}</td>
            <td>${kayit.tarih}</td>
            <td>${kayit.islem}</td>
            <td><button class="btn-sil">Sil</button></td>
          `;
          const btnSil = tr.querySelector('button');
          btnSil.onclick = async () => {
            if (!confirm('Bu kaydı silmek istediğinizden emin misiniz?')) return;
            try {
              const res = await fetch(`/api/bakimlar/${plaka.toUpperCase()}/${index}`, { method: 'DELETE' });
              const data = await res.json();
              if (res.ok) {
                message.textContent = data.message;
                await listele(plaka);
                await listeTümPlakalar();
                olusturQrKod(plaka);
              } else {
                alert(data.message || 'Silme işlemi başarısız');
              }
            } catch {
              alert('Silme sırasında hata oluştu.');
            }
          };
          bakimlarListesi.appendChild(tr);
        });

        olusturQrKod(plaka);

      } catch (err) {
        message.textContent = 'Bakım kayıtları alınırken hata oluştu.';
        if (qrCode) qrCode.clear();
        console.error(err);
      }
    }

    ekleForm.onsubmit = async e => {
      e.preventDefault();
      const plaka = eklePlakaInput.value.trim().toUpperCase();
      const tarih = ekleTarihInput.value;
      const islem = ekleIslemInput.value.trim();

      if (!plaka || !tarih || !islem) {
        message.textContent = 'Lütfen tüm alanları doldurun.';
        return;
      }

      try {
        const res = await fetch(`/api/bakimlar/${plaka}`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ tarih, islem })
        });
        const data = await res.json();
        if (res.ok) {
          message.textContent = data.message;
          eklePlakaInput.value = '';
          ekleTarihInput.value = '';
          ekleIslemInput.value = '';
          await listele(plaka);
          await listeTümPlakalar();
          olusturQrKod(plaka);
        } else {
          message.textContent = data.message || 'Bakım ekleme başarısız.';
        }
      } catch (err) {
        message.textContent = 'Bakım eklenirken hata oluştu.';
        console.error(err);
      }
    };

    btnAra.onclick = () => {
      const plaka = aramaPlakaInput.value.trim();
      listele(plaka);
    };

    async function listeTümPlakalar() {
      try {
        const res = await fetch('/api/plakalar');
        if (!res.ok) throw new Error('Plakalar alınamadı.');
        const plakalar = await res.json();

        // Sadece butonları sil
        plakalarListesi.querySelectorAll('button').forEach(b => b.remove());

        plakalar.forEach(plaka => {
          const btn = document.createElement('button');
          btn.textContent = plaka.toUpperCase();
          btn.onclick = () => {
            aramaPlakaInput.value = plaka.toUpperCase();
            listele(plaka);
          };
          plakalarListesi.appendChild(btn);
        });
      } catch (err) {
        console.error(err);
      }
    }

    // Sayfa yüklendiğinde geçmiş plakaları listele
    listeTümPlakalar();

    // URL'den plaka varsa göster
    const params = new URLSearchParams(window.location.search);
    const plakaQuery = params.get('plaka');
    if (plakaQuery) {
      aramaPlakaInput.value = plakaQuery.toUpperCase();
      listele(plakaQuery);
    }
  </script>
</body>
</html>
