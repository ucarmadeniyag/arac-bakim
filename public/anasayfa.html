<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Bakım Kayıtları ve Servis Formu</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #plakalar li { cursor: pointer; padding: 5px; border-bottom: 1px solid #ccc; }
    #plakalar li:hover { background-color: #eee; }
    #bakimDetay { margin-top: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { padding: 8px; border: 1px solid #ccc; text-align: left; }
    #eklemeMesaji { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Bakım Kayıtları ve Servis Formu</h1>

  <h2>Plakalar</h2>
  <ul id="plakalar"></ul>

  <h2>Bakım Ekle</h2>
  <form id="bakimEkleForm">
    <label for="plakaInput">Araç Plakası:</label><br/>
    <input type="text" id="plakaInput" name="plaka" required /><br/><br/>

    
<label>1-) Motor Yağı:</label><br/>
<input type="text" name="motorYagi" /><br/><br/>

<label>2-) Yağ Filtresi:</label><br/>
<input type="text" name="yagFiltresi" /><br/><br/>

<label>3-) Hava Filtresi:</label><br/>
<input type="text" name="havaFiltresi" /><br/><br/>

<label>4-) Polen Filtresi:</label><br/>
<input type="text" name="polenFiltresi" /><br/><br/>

<label>5-) Yakıt Filtresi:</label><br/>
<input type="text" name="yakitFiltresi" /><br/><br/>

<label>6-) Diğer:</label><br/>
<input type="text" name="diger" /><br/><br/>

    <button type="submit">Bakım Ekle</button>
  </form>

  <p id="eklemeMesaji" style="display:none;"></p>

  <div id="bakimDetay">
    <h2>Bakım Detayları</h2>
    <button id="silButon" style="margin-bottom:10px; display:none;">Seçili Plakaya Ait Bakımları Sil</button>
    <table id="bakimTable" style="display:none;">
      <thead>
        <tr>
          <th>Tarih</th>
          <th>İşlem</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="noData" style="display:none;">Seçilen plaka için bakım kaydı bulunamadı.</p>
  </div>

  <script>
    const plakalarUl = document.getElementById('plakalar');
    const bakimTable = document.getElementById('bakimTable');
    const bakimTableBody = bakimTable.querySelector('tbody');
    const noData = document.getElementById('noData');
    const bakimEkleForm = document.getElementById('bakimEkleForm');
    const eklemeMesaji = document.getElementById('eklemeMesaji');
    const silButon = document.getElementById('silButon');
    let seciliPlaka = null;

    function plakayaTikla(plaka) {
      seciliPlaka = plaka;
      fetchBakimlar(plaka);
      silButon.style.display = 'inline-block';
    }

    async function plakalarListele() {
      try {
        const res = await fetch('/api/plakalar');
        const plakalar = await res.json();

        plakalarUl.innerHTML = '';
        plakalar.forEach(plaka => {
          const li = document.createElement('li');
          li.textContent = plaka;
          li.addEventListener('click', () => plakayaTikla(plaka));
          plakalarUl.appendChild(li);
        });
      } catch (err) {
        console.error('Plakalar alınırken hata:', err);
      }
    }

    async function fetchBakimlar(plaka) {
      try {
        const res = await fetch(`/api/bakimlar/${plaka}`);
        const bakimlar = await res.json();

        bakimTableBody.innerHTML = '';
        if (bakimlar.length === 0) {
          bakimTable.style.display = 'none';
          noData.style.display = 'block';
        } else {
          noData.style.display = 'none';
          bakimTable.style.display = 'table';

          bakimlar.forEach(bakim => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${bakim.tarih}</td>
              <td>${bakim.islem}</td>
            `;
            bakimTableBody.appendChild(tr);
          });
        }
      } catch (err) {
        console.error('Bakım kayıtları alınırken hata:', err);
      }
    }

    bakimEkleForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const plaka = document.getElementById('plakaInput').value.trim().toUpperCase();
     const motorYagi = bakimEkleForm.elements["motorYagi"].value.trim();
const yagFiltresi = bakimEkleForm.elements["yagFiltresi"].value.trim();
const havaFiltresi = bakimEkleForm.elements["havaFiltresi"].value.trim();
const polenFiltresi = bakimEkleForm.elements["polenFiltresi"].value.trim();
const yakitFiltresi = bakimEkleForm.elements["yakitFiltresi"].value.trim();
const diger = bakimEkleForm.elements["diger"].value.trim();

const islemParcalari = [
  motorYagi && `Motor Yağı: ${motorYagi}`,
  yagFiltresi && `Yağ Filtresi: ${yagFiltresi}`,
  havaFiltresi && `Hava Filtresi: ${havaFiltresi}`,
  polenFiltresi && `Polen Filtresi: ${polenFiltresi}`,
  yakitFiltresi && `Yakıt Filtresi: ${yakitFiltresi}`,
  diger && `Diğer: ${diger}`
].filter(Boolean);

if (islemParcalari.length === 0) {
  alert('En az bir işlem alanı doldurulmalı.');
  return;
}

const islem = islemParcalari.join(', ');

      const tarih = new Date().toISOString().split('T')[0];

      if (!plaka || !islem) {
        alert('Lütfen tüm alanları doldurun.');
        return;
      }

      try {
        const res = await fetch(`/api/bakimlar/${plaka}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tarih, islem })
        });

        const data = await res.json();

        if (res.ok) {
          eklemeMesaji.textContent = 'Bakım kaydı başarıyla eklendi!';
          eklemeMesaji.style.color = 'green';
          eklemeMesaji.style.display = 'block';
          bakimEkleForm.reset();

          if (![...plakalarUl.children].some(li => li.textContent === plaka)) {
            const li = document.createElement('li');
            li.textContent = plaka;
            li.addEventListener('click', () => plakayaTikla(plaka));
            plakalarUl.appendChild(li);
          }

          fetchBakimlar(plaka);
        } else {
          eklemeMesaji.textContent = data.message || 'Bir hata oluştu!';
          eklemeMesaji.style.color = 'red';
          eklemeMesaji.style.display = 'block';
        }
      } catch (err) {
        eklemeMesaji.textContent = 'Sunucuya bağlanırken hata oluştu.';
        eklemeMesaji.style.color = 'red';
        eklemeMesaji.style.display = 'block';
      }
    });

    silButon.addEventListener('click', async () => {
      if (!seciliPlaka) {
        alert('Lütfen önce bir plaka seçin.');
        return;
      }
      if (!confirm(`${seciliPlaka} plakalı aracın tüm bakım kayıtlarını silmek istediğinize emin misiniz?`)) {
        return;
      }

      try {
        const res = await fetch(`/api/bakimlar/${seciliPlaka}`, {
          method: 'DELETE',
        });
        const data = await res.json();

        if (res.ok) {
          alert('Bakım kayıtları başarıyla silindi.');
          bakimTableBody.innerHTML = '';
          bakimTable.style.display = 'none';
          noData.style.display = 'block';
          silButon.style.display = 'none';
        } else {
          alert(data.message || 'Silme işlemi sırasında hata oluştu.');
        }
      } catch (err) {
        alert('Sunucuya bağlanırken hata oluştu.');
      }
    });

    plakalarListele();
  </script>
</body>
</html>
